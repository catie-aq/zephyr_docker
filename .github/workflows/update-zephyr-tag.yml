name: Update Dockerfile and Tag

on:
  push:

jobs:
  update-dockerfile:
    runs-on: sonu-github-arc
    container:
      image: ubuntu:latest

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y curl jq git

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: workdir
      
      - name: Set up git
        run: |
          cd workdir
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global pull.rebase true
          git pull origin main

      - name: Get latest tag from zephyrproject-rtos/docker-image
        id: get_latest_zephyr_tag
        run: |
          latest_zephyr_tag=$(curl -s https://api.github.com/repos/zephyrproject-rtos/docker-image/tags | jq -r '.[0].name')
          echo "::set-output name=zephyr_tag::$latest_zephyr_tag"

      - name: Get Previous tag
        id: previous_tag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
        with:
          workingDirectory: workdir

      - name: Update Dockerfile, commit, push changes, and create new tag if necessary
        if: steps.get_latest_zephyr_tag.outputs.zephyr_tag != steps.previous_tag.outputs.tag
        run: |
          cd workdir
          latest_zephyr_tag=${{ steps.get_latest_zephyr_tag.outputs.zephyr_tag }}
          sed -i "s|^FROM zephyrprojectrtos/ci:.*|FROM zephyrprojectrtos/ci:${latest_zephyr_tag}|" Dockerfile
          git add Dockerfile
          git commit -m "Update Dockerfile to use zephyrprojectrtos/ci:${latest_zephyr_tag}"
          git push origin main
          git tag $latest_zephyr_tag
          git push origin $latest_zephyr_tag